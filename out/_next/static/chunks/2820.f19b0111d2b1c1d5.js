"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2820],{55782:function(e,n,t){var i=t(85893),l=t(67294),a=t(88196),r=t(92365),o=t(40110),d=t(44723),s=t(90633),c=t(60990),h=t(97182),u=t(96788),g=t(51015),m=t(56912),x=t(68573),y=t(40492),p=t(6897),f=t(94143),b=t(29346),v=t(15972),T=t(96727),D=t(24961),j=t(68963),C=t(83063),I=t(18708);let Z="DIEM_CANH_DE",L=e=>{let n={I:1,V:5,X:10},t=0;for(let i=0;i<e.length;i++){let l=n[e[i]],a=i+1<e.length?n[e[i+1]]:0;l<a?(t+=a-l,i++):t+=l}return t},N=e=>{if(!e)return e;let n=e.trim().split(" "),t=[...n];for(let e=0;e<n.length;e++){let i=n[e];if(/^[IVX]+$/i.test(i))try{let n=L(i.toUpperCase());t[e]=String(n)}catch(e){}let l=i.match(/^([A-Za-zÀ-ỹ]+)([IVX]+)$/i);if(l){let[,n,i]=l;try{let l=L(i.toUpperCase());t[e]="".concat(n).concat(l)}catch(e){}}}let i=e.match(/^(.+)-([IVX]+)$/i);if(i){let[,e,n]=i;try{let t=L(n.toUpperCase());return"".concat(e,"-").concat(t)}catch(e){}}return t.join(" ")},k=(e,n)=>{if(!e||!n)return 0;let t=e=>e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g,"").replace(/\s+/g," ").trim(),i=t(e),l=t(n),a=i.split(/\s+/).filter(Boolean),r=l.split(/\s+/).filter(Boolean),o=0,d=0,s=["ta","huu","song","bien","dong","tay","bac","nam"];for(let e of a)r.includes(e)&&(o++,s.includes(e)&&d++);let c=Math.max(a.length,r.length),h=c>0?o/c:0;return d>0&&(h+=.1*d,h=Math.min(1,h)),h};n.Z=e=>{var n;let{onClose:t,onSaveComplete:L,open:S,editDiemCanhDe:w}=e,[K,P]=(0,l.useState)(null),[z,E]=(0,l.useState)([]),[M,F]=(0,l.useState)({tenDiemCanh:"",viTriKM:"",toaDo:"",kieuNhaTruc:"",soNguoiTruc:void 0,moTa:"",maLoaiCongTrinh:Z,loaiCongTrinhId:"",tuyenDeId:null,doanDeId:null}),[O,A]=(0,l.useState)(!0),[J,W]=(0,l.useState)(!1),[_,R]=(0,l.useState)(null),[V,G]=(0,l.useState)(null),[X,B]=(0,l.useState)(0),[U,$]=(0,l.useState)(""),[q,H]=(0,l.useState)([]),[Q,Y]=(0,l.useState)([]);(0,l.useEffect)(()=>{(async()=>{try{let e=(await (await I.I.getAllLoaiCongTrinh(1,1e3,!1)).items).find(e=>e.maLoai===Z);e&&($(e.id),F(n=>({...n,loaiCongTrinhId:e.id})))}catch(e){R("Kh\xf4ng thể tải danh s\xe1ch loại c\xf4ng tr\xecnh")}})()},[]),(0,l.useEffect)(()=>{let e=async()=>{try{let e=await I.I.getAllTuyenDe({pageNumber:1,pageSize:100},!1);H(e.items||[])}catch(e){console.error("Error fetching tuyến đ\xea list:",e)}};S&&e()},[S]),(0,l.useEffect)(()=>{(async()=>{if(!M.tuyenDeId){Y([]);return}try{let e=await I.I.getAllDoanDe({tuyenDeId:M.tuyenDeId,pageNumber:1,pageSize:100},!1);Y(e.items||[])}catch(e){console.error("Error fetching đoạn đ\xea list:",e)}})()},[M.tuyenDeId]),(0,l.useEffect)(()=>{w&&S&&U&&(console.log("Editing diemCanhDe:",w),F({...w,maLoaiCongTrinh:Z,loaiCongTrinhId:w.loaiCongTrinhId||U,tuyenDeId:w.tuyenDeId||null,doanDeId:w.doanDeId||null}),A(!0)),S||F({tenDiemCanh:"",viTriKM:"",toaDo:"",kieuNhaTruc:"",soNguoiTruc:void 0,moTa:"",maLoaiCongTrinh:Z,loaiCongTrinhId:U,tuyenDeId:null,doanDeId:null})},[w,S,U]);let ee=e=>{let{name:n,value:t,type:i}=e.target;F(e=>({...e,[n]:"number"===i?t?Number(t):void 0:t}))},en=async()=>{if(!M.tenDiemCanh){R("T\xean điểm canh đ\xea kh\xf4ng được để trống");return}if(!M.loaiCongTrinhId&&!U){R("Loại c\xf4ng tr\xecnh kh\xf4ng được để trống");return}W(!0),R(null),G(null);try{let e=M.toaDo;if("string"==typeof e&&e)try{e=JSON.parse(e)}catch(n){e=null}await C.a.createDiemCanhDe({...M,maLoaiCongTrinh:Z,loaiCongTrinhId:M.loaiCongTrinhId||U,tuyenDeId:M.tuyenDeId,doanDeId:M.doanDeId,toaDo:e}),G("Lưu th\xe0nh c\xf4ng bản ghi điểm canh đ\xea!"),F({tenDiemCanh:"",viTriKM:"",toaDo:"",kieuNhaTruc:"",soNguoiTruc:void 0,moTa:"",maLoaiCongTrinh:Z,loaiCongTrinhId:U,tuyenDeId:null,doanDeId:null}),setTimeout(()=>{L()},1500)}catch(e){R("Lỗi khi lưu bản ghi điểm canh đ\xea. Vui l\xf2ng thử lại.")}finally{W(!1)}},et=async()=>{if(0===z.length){R("Kh\xf4ng c\xf3 dữ liệu để lưu");return}W(!0),R(null),G(null);try{let e=z.length,n=0,t=[];for(let i of z){let l=i.toaDo;if("string"==typeof l&&l)try{l=JSON.parse(l)}catch(e){l=null}try{await C.a.createDiemCanhDe({...i,maLoaiCongTrinh:Z,loaiCongTrinhId:i.loaiCongTrinhId||U,tuyenDeId:i.tuyenDeId,doanDeId:i.doanDeId,toaDo:l}),n++,B(Math.floor(n/e*100))}catch(e){t.push(i.tenDiemCanh||"Kh\xf4ng t\xean")}}0===t.length?G("Lưu th\xe0nh c\xf4ng ".concat(n," điểm canh đ\xea")):(G("Đ\xe3 lưu ".concat(n,"/").concat(e," điểm canh đ\xea. C\xf3 ").concat(t.length," điểm canh đ\xea kh\xf4ng lưu được.")),R("C\xe1c điểm canh đ\xea lỗi: ".concat(t.join(", ")))),n>0&&setTimeout(()=>{L()},2e3)}catch(e){R("Lỗi khi lưu dữ liệu. Vui l\xf2ng thử lại.")}finally{W(!1)}};return(0,i.jsxs)(a.Z,{open:S,onClose:J?void 0:t,maxWidth:"md",fullWidth:!0,children:[(0,i.jsx)(r.Z,{children:"Quản l\xfd điểm canh đ\xea (th\xeam/sửa từng bản ghi hoặc nhập file GeoJSON)"}),(0,i.jsxs)(o.Z,{children:[V&&(0,i.jsxs)(d.Z,{severity:"success",sx:{mb:2},children:[(0,i.jsx)(s.Z,{children:"Th\xe0nh c\xf4ng"}),V]}),_&&(0,i.jsxs)(d.Z,{severity:"error",sx:{mb:2},children:[(0,i.jsx)(s.Z,{children:"Lỗi"}),_]}),J&&(0,i.jsxs)(c.Z,{sx:{display:"flex",alignItems:"center",mb:2},children:[(0,i.jsx)(h.Z,{variant:"determinate",value:X,sx:{mr:2}}),(0,i.jsxs)(u.Z,{variant:"body2",color:"text.secondary",children:["Đang lưu... ",X,"%"]})]}),(0,i.jsxs)(c.Z,{sx:{mb:3},children:[(0,i.jsx)(u.Z,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Bạn c\xf3 thể nhập từng điểm canh đ\xea hoặc chuyển sang nhập file GeoJSON để th\xeam h\xe0ng loạt. File cần c\xf3 cấu tr\xfac FeatureCollection với c\xe1c Feature chứa th\xf4ng tin điểm canh đ\xea."}),(0,i.jsxs)(c.Z,{sx:{display:"flex",gap:2,mb:2},children:[(0,i.jsx)(g.Z,{variant:O?"contained":"outlined",onClick:()=>A(!0),disabled:O||J,children:"Nhập từng điểm canh đ\xea"}),(0,i.jsx)(g.Z,{variant:O?"outlined":"contained",onClick:()=>A(!1),disabled:!O||J,children:"Import file GeoJSON"})]}),O&&(0,i.jsxs)(c.Z,{sx:{mb:3,p:2,border:"1px solid #eee",borderRadius:2},children:[(0,i.jsx)(m.Z,{textAlign:"center",children:"Th\xf4ng tin điểm canh đ\xea"}),(0,i.jsxs)(x.ZP,{container:!0,spacing:4,sx:{mt:2},children:[(0,i.jsx)(x.ZP,{item:!0,xs:12,sm:6,children:(0,i.jsx)(y.Z,{name:"tenDiemCanh",label:"T\xean điểm canh đ\xea",value:M.tenDiemCanh,onChange:ee,variant:"outlined",fullWidth:!0,size:"small",disabled:J,InputLabelProps:{shrink:!0}})}),(0,i.jsx)(x.ZP,{item:!0,xs:12,sm:6,children:(0,i.jsx)(y.Z,{name:"viTriKM",label:"Vị tr\xed KM",value:M.viTriKM,onChange:ee,variant:"outlined",fullWidth:!0,size:"small",disabled:J,InputLabelProps:{shrink:!0}})}),(0,i.jsx)(x.ZP,{item:!0,xs:12,children:(0,i.jsx)(y.Z,{name:"toaDo",label:"Toạ độ (GeoJSON Feature object)",value:M.toaDo,onChange:ee,variant:"outlined",fullWidth:!0,size:"small",disabled:J,multiline:!0,minRows:2,InputLabelProps:{shrink:!0}})}),(0,i.jsx)(x.ZP,{item:!0,xs:12,sm:6,children:(0,i.jsx)(y.Z,{name:"kieuNhaTruc",label:"Kiểu nh\xe0 trực",value:M.kieuNhaTruc,onChange:ee,variant:"outlined",fullWidth:!0,size:"small",disabled:J,InputLabelProps:{shrink:!0}})}),(0,i.jsx)(x.ZP,{item:!0,xs:12,sm:6,children:(0,i.jsx)(y.Z,{name:"soNguoiTruc",label:"Số người trực",value:null!==(n=M.soNguoiTruc)&&void 0!==n?n:"",onChange:ee,type:"number",variant:"outlined",fullWidth:!0,size:"small",disabled:J,InputLabelProps:{shrink:!0}})}),(0,i.jsx)(x.ZP,{item:!0,xs:12,sm:6,children:(0,i.jsxs)(p.Z,{fullWidth:!0,size:"small",children:[(0,i.jsx)(f.Z,{id:"loai-cong-trinh-label",children:"Loại c\xf4ng tr\xecnh"}),(0,i.jsxs)(b.Z,{labelId:"loai-cong-trinh-label",name:"loaiCongTrinhId",value:M.loaiCongTrinhId||"",onChange:e=>{let n=e.target.value;F(e=>({...e,loaiCongTrinhId:""===n?null:n}))},disabled:J,label:"Loại c\xf4ng tr\xecnh",children:[(0,i.jsx)(v.Z,{value:"",children:(0,i.jsx)("em",{children:"Kh\xf4ng chọn"})}),U&&(0,i.jsx)(v.Z,{value:U,children:"Điểm canh đ\xea"},U)]})]})}),(0,i.jsx)(x.ZP,{item:!0,xs:12,sm:6,children:(0,i.jsxs)(p.Z,{fullWidth:!0,size:"small",children:[(0,i.jsx)(f.Z,{id:"tuyen-de-label",children:"Tuyến đ\xea"}),(0,i.jsxs)(b.Z,{labelId:"tuyen-de-label",name:"tuyenDeId",value:M.tuyenDeId||"",onChange:e=>{let n=e.target.value;F(e=>({...e,tuyenDeId:""===n?null:n,doanDeId:null}))},disabled:J,label:"Tuyến đ\xea",children:[(0,i.jsx)(v.Z,{value:"",children:(0,i.jsx)("em",{children:"Kh\xf4ng chọn"})}),q.map(e=>(0,i.jsx)(v.Z,{value:e.id,children:e.tenTuyenDe},e.id))]})]})}),(0,i.jsx)(x.ZP,{item:!0,xs:12,sm:6,children:(0,i.jsxs)(p.Z,{fullWidth:!0,size:"small",children:[(0,i.jsx)(f.Z,{id:"doan-de-label",children:"Đoạn đ\xea"}),(0,i.jsxs)(b.Z,{labelId:"doan-de-label",name:"doanDeId",value:M.doanDeId||"",onChange:e=>{let n=e.target.value;F(e=>({...e,doanDeId:""===n?null:n}))},disabled:J||!M.tuyenDeId,label:"Đoạn đ\xea",children:[(0,i.jsx)(v.Z,{value:"",children:(0,i.jsx)("em",{children:"Kh\xf4ng chọn"})}),Q.map(e=>(0,i.jsx)(v.Z,{value:e.id,children:e.tenDoan},e.id))]})]})}),(0,i.jsx)(x.ZP,{item:!0,xs:12,children:(0,i.jsx)(y.Z,{name:"moTa",label:"M\xf4 tả",value:M.moTa,onChange:ee,variant:"outlined",fullWidth:!0,size:"small",disabled:J,multiline:!0,minRows:2,InputLabelProps:{shrink:!0}})})]})]}),!O&&(0,i.jsxs)(c.Z,{sx:{border:"1px dashed #ccc",p:3,my:3,textAlign:"center",borderRadius:1},children:[(0,i.jsxs)(g.Z,{variant:"contained",component:"label",startIcon:(0,i.jsx)(D.Z,{}),disabled:J,children:["Chọn file GeoJSON",(0,i.jsx)("input",{type:"file",hidden:!0,accept:".geojson,.json",onChange:e=>{var n;let t=null===(n=e.target.files)||void 0===n?void 0:n[0];if(!t)return;P(t),R(null);let i=new FileReader;i.onload=e=>{try{var n;let t=JSON.parse(null===(n=e.target)||void 0===n?void 0:n.result);if(!t.type||"FeatureCollection"!==t.type||!t.features){R("File kh\xf4ng phải l\xe0 GeoJSON FeatureCollection hợp lệ");return}if(!U){R("Chưa c\xf3 loại c\xf4ng tr\xecnh ID cho điểm canh đ\xea, vui l\xf2ng thử lại sau");return}let i=t.features.map((e,n)=>{var t,i,l,a,r;let o=e;if("string"==typeof o)try{o=JSON.parse(o)}catch(e){o=null}let d=(null===(t=e.properties)||void 0===t?void 0:t.Thuoc_Tde)||"",s=null,c=null;for(let e of(d.includes(",")&&(d=d.split(",")[0].trim()),["đ\xea ","de ","tuyen ","tuyến "]))if(d.toLowerCase().startsWith(e)){d=d.substring(e.length);break}if(d&&q.length>0){let e=d.toLowerCase().includes("biển"),n=N(d);(s=q.find(n=>{let t=n.tenTuyenDe.toLowerCase()===d.toLowerCase();if(e){var i;return t&&(null===(i=n.loaiDe)||void 0===i?void 0:i.toLowerCase())==="đ\xea biển"}return t}))||(s=q.find(t=>{let i=N(t.tenTuyenDe).toLowerCase()===n.toLowerCase();if(e){var l;return i&&(null===(l=t.loaiDe)||void 0===l?void 0:l.toLowerCase())==="đ\xea biển"}return i}));let t=e=>e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g,"").replace(/\s+/g," ").trim();if(!s){let i=(e=>{let n=t(e).split(" ");for(let[t,i]of Object.entries({thh:"ta hong ha",hhh:"huu hong ha",td:"ta day",hd:"huu day",hl:"huu luoc",tl:"ta luoc"}))if(n.includes(t))return e.replace(RegExp("\\b".concat(t,"\\b"),"i"),i);return e})(d);if(i!==d&&(s=q.find(e=>t(e.tenTuyenDe).includes(t(i)))),!s){let t=q.filter(n=>{var t;return!e||(null===(t=n.loaiDe)||void 0===t?void 0:t.toLowerCase())==="đ\xea biển"}).map(e=>({tuyenDe:e,similarity:k(N(e.tenTuyenDe),n)})).sort((e,n)=>n.similarity-e.similarity);t.length>0&&t[0].similarity>.6&&(s=t[0].tuyenDe)}}s&&(c=s.id)}return{tenDiemCanh:(null===(i=e.properties)||void 0===i?void 0:i.Ten_Diem)||"Điểm canh đ\xea ".concat(n+1),viTriKM:(null===(l=e.properties)||void 0===l?void 0:l.Vitri_Km)||"",toaDo:o,kieuNhaTruc:(null===(a=e.properties)||void 0===a?void 0:a.Kich_thuoc)||"",soNguoiTruc:void 0,moTa:(null===(r=e.properties)||void 0===r?void 0:r.Thiet_bi)||"",maLoaiCongTrinh:Z,loaiCongTrinhId:U,tuyenDeId:c,doanDeId:null,tenTuyenDe:d}});E(i)}catch(e){R("Kh\xf4ng thể đọc file GeoJSON. Kiểm tra định dạng file.")}},i.readAsText(t)}})]}),K&&(0,i.jsxs)(u.Z,{variant:"body2",sx:{display:"flex",alignItems:"center"},children:[K.name," (",(K.size/1024).toFixed(1)," KB)"]})]}),z.length>0&&(0,i.jsxs)(c.Z,{sx:{mt:3},children:[(0,i.jsxs)(u.Z,{variant:"subtitle2",sx:{mb:1},children:["Xem trước dữ liệu (",z.length," điểm canh đ\xea)"]}),(0,i.jsx)(c.Z,{sx:{border:"1px solid #eee",borderRadius:2,overflow:"auto"},children:(0,i.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse"},children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{style:{background:"#f5f5f5"},children:[(0,i.jsx)("th",{style:{padding:8,border:"1px solid #ddd"},children:"STT"}),(0,i.jsx)("th",{style:{padding:8,border:"1px solid #ddd"},children:"T\xean điểm canh"}),(0,i.jsx)("th",{style:{padding:8,border:"1px solid #ddd"},children:"Vị tr\xed KM"}),(0,i.jsx)("th",{style:{padding:8,border:"1px solid #ddd"},children:"Kiểu nh\xe0 trực"}),(0,i.jsx)("th",{style:{padding:8,border:"1px solid #ddd"},children:"Số người trực"}),(0,i.jsx)("th",{style:{padding:8,border:"1px solid #ddd"},children:"Tuyến đ\xea"})]})}),(0,i.jsx)("tbody",{children:z.map((e,n)=>(0,i.jsxs)("tr",{children:[(0,i.jsx)("td",{style:{padding:8,border:"1px solid #ddd",textAlign:"center"},children:n+1}),(0,i.jsx)("td",{style:{padding:8,border:"1px solid #ddd"},children:e.tenDiemCanh}),(0,i.jsx)("td",{style:{padding:8,border:"1px solid #ddd"},children:e.viTriKM}),(0,i.jsx)("td",{style:{padding:8,border:"1px solid #ddd"},children:e.kieuNhaTruc}),(0,i.jsx)("td",{style:{padding:8,border:"1px solid #ddd"},children:e.soNguoiTruc}),(0,i.jsx)("td",{style:{padding:8,border:"1px solid #ddd"},children:e.tenTuyenDe})]},n))})]})})]})]})]}),(0,i.jsxs)(T.Z,{children:[(0,i.jsx)(g.Z,{onClick:()=>{P(null),E([]),F({tenDiemCanh:"",viTriKM:"",toaDo:"",kieuNhaTruc:"",soNguoiTruc:void 0,moTa:"",maLoaiCongTrinh:Z,loaiCongTrinhId:U,tuyenDeId:null,doanDeId:null}),M.tuyenDeId&&Y([]),R(null),G(null),B(0)},disabled:J||0===z.length&&!K,children:"X\xf3a"}),(0,i.jsx)(g.Z,{onClick:t,disabled:J,children:"Đ\xf3ng"}),(0,i.jsx)(g.Z,{onClick:()=>{O&&0===z.length?en():et()},variant:"contained",color:"primary",disabled:J||(O?!M.tenDiemCanh||!M.loaiCongTrinhId:0===z.length),startIcon:J?(0,i.jsx)(h.Z,{size:20}):(0,i.jsx)(j.Z,{}),children:J?"Đang lưu...":"Lưu"})]})]})}},87643:function(e,n,t){var i=t(67294),l=t(39153),a=t(45243),r=t.n(a),o=t(29291),d=t(92893),s=t(36637);n.Z=e=>{let n=(0,l.Sx)(),{filteredDCanhList:t,handleDCanhClick:a,layerLabelState:c,legendData:h,focusedId:u}=(0,o.Y)(),g=i.useRef(null),m=i.useRef({}),x=i.useRef(null),y=e.data||t;return i.useEffect(()=>{if(!n.getPane("dcanhPane")){let e=n.createPane("dcanhPane");e.style.zIndex="652",e.style.pointerEvents="auto"}},[n]),i.useEffect(()=>{if(g.current&&n.removeLayer(g.current),!y||0===y.length)return;let e=r().featureGroup();return g.current=e,y.forEach(n=>{let t=n.toaDo;if(!t)return;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return}if(!t.geometry||!t.geometry.coordinates)return;let i=t.geometry.coordinates,l=n.color||"#FF9800";if(!Array.isArray(i)||i.length<2)return;let o=i[1],u=i[0],g=(0,d.oN)(h,n),x=(0,s.L)(o,u,g,l,{pane:"dcanhPane"});n.maLoaiCongTrinh&&c[n.maLoaiCongTrinh]&&x.bindTooltip(n.tenDCanh,{permanent:!0,className:"map-label dcanh-label",opacity:1}),x.on("click",e=>{a(n,[e.latlng.lat,e.latlng.lng]),r().DomEvent.stopPropagation(e)}),e.addLayer(x),n.id&&(m.current[n.id]=x)}),e.addTo(n),e.bringToFront(),()=>{g.current&&n.removeLayer(g.current)}},[y,n,a,c,h]),i.useEffect(()=>{if(!n)return;let e=()=>{let e=n.getZoom();setTimeout(()=>{document.querySelectorAll(".dcanh-label").forEach(n=>{e<12?(n.style.display="none",n.style.opacity="0",n.style.visibility="hidden",n.classList.add("DCanh-hidden-tooltip")):(n.style.display="block",n.style.opacity="1",n.style.visibility="visible",n.classList.remove("DCanh-hidden-tooltip"))})},100)};return n.on("zoomend",e),e(),()=>{n.off("zoomend",e)}},[n]),i.useEffect(()=>{if(x.current){try{n.removeLayer(x.current)}catch(e){}x.current=null}if(!u)return;let e=m.current[u];if(e)try{if(e.getLatLng){let t=e.getLatLng();n.flyTo(t,Math.max(n.getZoom(),15),{duration:.75});let i=r().circleMarker(t,{radius:10,color:"#ff9800",weight:3,opacity:.9,fillColor:"#ff9800",fillOpacity:.15,pane:"dcanhPane"});i.addTo(n),i.bringToFront(),x.current=i;return}}catch(e){console.error("Kh\xf4ng thể zoom tới điểm canh đ\xea đ\xe3 chọn:",e)}},[u,n]),i.useEffect(()=>()=>{if(x.current)try{n.removeLayer(x.current)}catch(e){}},[n]),null}}}]);