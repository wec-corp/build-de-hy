"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7096],{60553:function(e,t,n){var i=n(85893),r=n(67294),o=n(88196),l=n(92365),a=n(40110),c=n(44723),s=n(90633),d=n(60990),u=n(97182),h=n(96788),g=n(51015),p=n(50333),m=n(40492),y=n(56912),f=n(68573),v=n(25026),x=n(93454),b=n(76592),K=n(70360),j=n(46577),Z=n(8863),k=n(19827),L=n(96727),S=n(24961),D=n(68963),C=n(72744),T=n(18708);t.Z=e=>{let{onClose:t,onSaveComplete:n,open:N,editKe:O}=e,[E,F]=(0,r.useState)(null),[P,I]=(0,r.useState)([]),[J,G]=(0,r.useState)({tenKe:"",vitriKm:"",chieuDai:"",vatLieu:"",geometry:""}),[w,z]=(0,r.useState)(null);r.useEffect(()=>{O&&N&&(G({tenKe:O.tenKe||"",vitriKm:O.vitriKm||"",chieuDai:O.chieuDai?String(O.chieuDai):"",vatLieu:O.vatLieu||"",geometry:O.toaDo?"string"==typeof O.toaDo?O.toaDo:JSON.stringify(O.toaDo):""}),B(O.loaiCongTrinhId||""),$(O.tuyenDeId||""),V(!0),z(null)),N||(G({tenKe:"",vitriKm:"",chieuDai:"",vatLieu:"",geometry:""}),z(null))},[O,N]);let[A,V]=(0,r.useState)(!0),[W,B]=(0,r.useState)(""),[_,M]=(0,r.useState)([]),[R,q]=(0,r.useState)(!1),[H,X]=(0,r.useState)(null),[Q,U]=(0,r.useState)(null),[Y,$]=(0,r.useState)(""),[ee,et]=(0,r.useState)([]),[en,ei]=(0,r.useState)(0);(0,r.useEffect)(()=>{let e=async()=>{try{var e;let t=await T.I.getAllTuyenDe({pageNumber:1,pageSize:1e3});et((null===(e=t.items)||void 0===e?void 0:e.map(e=>({id:e.id||"",tenTuyenDe:e.tenTuyenDe||""})))||[])}catch(e){console.error("Error fetching tuyến đ\xea:",e),X("Kh\xf4ng thể tải danh s\xe1ch tuyến đ\xea")}};(async()=>{try{let e=await T.I.getLoaiCongTrinhTree(),t=[],n=e=>{e.children&&e.children.length>0?e.children.forEach(n):t.push({id:e.id,tenLoai:e.tenLoai})};e.forEach(e=>{e.tenLoai.toLowerCase().includes("k\xe8")&&e.children&&e.children.forEach(n)}),M(t)}catch(e){console.error("Error fetching loại c\xf4ng tr\xecnh:",e),X("Kh\xf4ng thể tải danh s\xe1ch loại c\xf4ng tr\xecnh")}})(),e()},[]);let er=e=>{let{name:t,value:n}=e.target;G(e=>({...e,[t]:n}))},eo=async()=>{if(!J.tenKe){X("T\xean k\xe8 kh\xf4ng được để trống");return}q(!0),X(null),U(null);try{let e={tenKe:J.tenKe,loaiCongTrinhId:W||void 0,tuyenDeId:Y||void 0,diaDiem:"",toaDo:J.geometry?{type:"Feature",geometry:JSON.parse(J.geometry)}:void 0,chieuDai:J.chieuDai?parseFloat(J.chieuDai):void 0,vatLieu:J.vatLieu||""};await C.M.saveKe(e),U("Lưu th\xe0nh c\xf4ng bản ghi k\xe8!"),G({tenKe:"",vitriKm:"",chieuDai:"",vatLieu:"",geometry:""}),setTimeout(()=>{n()},1500)}catch(e){X("Lỗi khi lưu bản ghi k\xe8. Vui l\xf2ng thử lại.")}finally{q(!1)}},el=async()=>{if(0===P.length){X("Kh\xf4ng c\xf3 dữ liệu để lưu");return}q(!0),X(null),U(null);try{let e=P.length,t=0,i=[];for(let n of P)try{let i={tenKe:n.tenKe,loaiCongTrinhId:W||void 0,tuyenDeId:Y||void 0,diaDiem:"",toaDo:n.geometry?{type:"Feature",geometry:n.geometry}:void 0,chieuDai:n.chieuDai?parseFloat(n.chieuDai):void 0,vatLieu:n.vatLieu||""};await C.M.saveKe(i),t++,ei(Math.floor(t/e*100))}catch(e){i.push(n.tenKe||"Kh\xf4ng t\xean")}0===i.length?U("Lưu th\xe0nh c\xf4ng ".concat(t," k\xe8")):(U("Đ\xe3 lưu ".concat(t,"/").concat(e," k\xe8. C\xf3 ").concat(i.length," k\xe8 kh\xf4ng lưu được.")),X("C\xe1c k\xe8 lỗi: ".concat(i.join(", ")))),t>0&&setTimeout(()=>{n()},2e3)}catch(e){X("Lỗi khi lưu dữ liệu. Vui l\xf2ng thử lại.")}finally{q(!1)}};return(0,i.jsxs)(o.Z,{open:N,onClose:R?void 0:t,maxWidth:"md",fullWidth:!0,children:[(0,i.jsx)(l.Z,{children:"Quản l\xfd k\xe8 (th\xeam/sửa từng bản ghi hoặc nhập file GeoJSON)"}),(0,i.jsxs)(a.Z,{children:[Q&&(0,i.jsxs)(c.Z,{severity:"success",sx:{mb:2},children:[(0,i.jsx)(s.Z,{children:"Th\xe0nh c\xf4ng"}),Q]}),H&&(0,i.jsxs)(c.Z,{severity:"error",sx:{mb:2},children:[(0,i.jsx)(s.Z,{children:"Lỗi"}),H]}),R&&(0,i.jsxs)(d.Z,{sx:{display:"flex",alignItems:"center",mb:2},children:[(0,i.jsx)(u.Z,{variant:"determinate",value:en,sx:{mr:2}}),(0,i.jsxs)(h.Z,{variant:"body2",color:"text.secondary",children:["Đang lưu... ",en,"%"]})]}),(0,i.jsxs)(d.Z,{sx:{mb:3},children:[(0,i.jsx)(h.Z,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Bạn c\xf3 thể nhập từng k\xe8 (ưu ti\xean) hoặc chuyển sang nhập file GeoJSON để th\xeam h\xe0ng loạt. File cần c\xf3 cấu tr\xfac FeatureCollection với c\xe1c Feature chứa th\xf4ng tin k\xe8."}),!O&&(0,i.jsxs)(d.Z,{sx:{display:"flex",gap:2,mb:2},children:[(0,i.jsx)(g.Z,{variant:A?"contained":"outlined",onClick:()=>V(!0),disabled:A||R,children:"Nhập từng k\xe8"}),(0,i.jsx)(g.Z,{variant:A?"outlined":"contained",onClick:()=>V(!1),disabled:!A||R,children:"Import file GeoJSON"})]}),(0,i.jsxs)(d.Z,{sx:{display:"flex",gap:2,mb:3},children:[(0,i.jsx)(p.Z,{fullWidth:!0,size:"small",options:_,getOptionLabel:e=>e.tenLoai||"",value:_.find(e=>e.id===W)||null,onChange:(e,t)=>B(t?t.id:""),disabled:R,renderInput:e=>(0,i.jsx)(m.Z,{...e,label:"Loại c\xf4ng tr\xecnh",placeholder:"-- Kh\xf4ng chọn --"}),renderOption:(e,t)=>(0,r.createElement)("li",{...e,key:t.id},t.tenLoai)}),(0,i.jsx)(p.Z,{fullWidth:!0,size:"small",options:ee,getOptionLabel:e=>e.tenTuyenDe||"",value:ee.find(e=>e.id===Y)||null,onChange:(e,t)=>$(t?t.id:""),disabled:R||!A,renderInput:e=>(0,i.jsx)(m.Z,{...e,label:"Tuyến đ\xea",placeholder:"-- Kh\xf4ng chọn --"}),renderOption:(e,t)=>(0,r.createElement)("li",{...e,key:t.id},t.tenTuyenDe)})]}),A&&(0,i.jsxs)(d.Z,{sx:{mb:3,p:2,border:"1px solid #eee",borderRadius:2},children:[(0,i.jsx)(y.Z,{textAlign:"center",children:"Th\xf4ng tin k\xe8"}),(0,i.jsxs)(f.ZP,{container:!0,spacing:4,sx:{mt:2},children:[(0,i.jsx)(f.ZP,{item:!0,xs:12,sm:6,children:(0,i.jsx)(m.Z,{name:"tenKe",label:"T\xean k\xe8",value:J.tenKe,onChange:er,placeholder:"T\xean k\xe8",variant:"outlined",fullWidth:!0,size:"small",disabled:R,InputLabelProps:{shrink:!0}})}),(0,i.jsx)(f.ZP,{item:!0,xs:12,sm:6,children:(0,i.jsx)(m.Z,{name:"vitriKm",label:"Vị tr\xed Km",value:J.vitriKm,onChange:er,placeholder:"Vị tr\xed Km",variant:"outlined",fullWidth:!0,size:"small",disabled:R,InputLabelProps:{shrink:!0}})}),(0,i.jsx)(f.ZP,{item:!0,xs:12,sm:6,children:(0,i.jsx)(m.Z,{name:"chieuDai",label:"Chiều d\xe0i (m)",value:J.chieuDai,onChange:er,placeholder:"Chiều d\xe0i (m)",type:"number",variant:"outlined",fullWidth:!0,size:"small",disabled:R,InputLabelProps:{shrink:!0}})}),(0,i.jsx)(f.ZP,{item:!0,xs:12,sm:6,children:(0,i.jsx)(m.Z,{name:"vatLieu",label:"Vật liệu",value:J.vatLieu,onChange:er,placeholder:"Vật liệu",variant:"outlined",fullWidth:!0,size:"small",disabled:R,InputLabelProps:{shrink:!0}})}),(0,i.jsx)(f.ZP,{item:!0,xs:12,children:(0,i.jsx)(m.Z,{name:"geometry",label:'Geometry (GeoJSON geometry object, v\xed dụ: {"type":"LineString","coordinates":[[x1,y1],[x2,y2]]})',value:J.geometry,onChange:er,placeholder:"D\xe1n chuỗi JSON geometry ở đ\xe2y",variant:"outlined",fullWidth:!0,size:"small",disabled:R,InputLabelProps:{shrink:!0},multiline:!0,minRows:2})})]})]}),!A&&(0,i.jsxs)(d.Z,{sx:{border:"1px dashed #ccc",p:3,my:3,textAlign:"center",borderRadius:1},children:[(0,i.jsxs)(g.Z,{variant:"contained",component:"label",startIcon:(0,i.jsx)(S.Z,{}),disabled:R,children:["Chọn file GeoJSON",(0,i.jsx)("input",{type:"file",hidden:!0,accept:".geojson,.json",onChange:e=>{var t;let n=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!n)return;F(n),X(null);let i=new FileReader;i.onload=e=>{try{var t;let n=JSON.parse(null===(t=e.target)||void 0===t?void 0:t.result);if(!n.type||"FeatureCollection"!==n.type||!n.features){X("File kh\xf4ng phải l\xe0 GeoJSON FeatureCollection hợp lệ");return}let i=n.features.map((e,t)=>{var n,i,r,o,l;return{id:t,tenKe:(null===(n=e.properties)||void 0===n?void 0:n.Ten_keMH)||(null===(i=e.properties)||void 0===i?void 0:i.name)||"K\xe8 ".concat(t+1),vitriKm:(null===(r=e.properties)||void 0===r?void 0:r.Vitri_Km)||"",chieuDai:parseFloat(null===(o=e.properties)||void 0===o?void 0:o.Chieu_dai)||0,vatLieu:(null===(l=e.properties)||void 0===l?void 0:l.Ket_cau)||"",geometry:e.geometry}});I(i)}catch(e){console.error("Error parsing GeoJSON file:",e),X("Kh\xf4ng thể đọc file GeoJSON. Kiểm tra định dạng file.")}},i.readAsText(n)}})]}),E&&(0,i.jsxs)(h.Z,{variant:"body2",sx:{display:"flex",alignItems:"center"},children:[E.name," (",(E.size/1024).toFixed(1)," KB)"]})]}),P.length>0&&(0,i.jsxs)(d.Z,{sx:{mt:3},children:[(0,i.jsxs)(h.Z,{variant:"h6",sx:{mb:1},children:["Xem trước dữ liệu (",P.length," k\xe8)"]}),(0,i.jsx)(v.Z,{component:x.Z,sx:{maxHeight:400},children:(0,i.jsxs)(b.Z,{stickyHeader:!0,size:"small",children:[(0,i.jsx)(K.Z,{children:(0,i.jsxs)(j.Z,{children:[(0,i.jsx)(Z.Z,{children:"STT"}),(0,i.jsx)(Z.Z,{children:"T\xean k\xe8"}),(0,i.jsx)(Z.Z,{children:"Vị tr\xed Km"}),(0,i.jsx)(Z.Z,{children:"Chiều d\xe0i"}),(0,i.jsx)(Z.Z,{children:"Vật liệu"}),(0,i.jsx)(Z.Z,{children:"Loại geometry"})]})}),(0,i.jsx)(k.Z,{children:P.map((e,t)=>{var n;return(0,i.jsxs)(j.Z,{hover:!0,selected:w===t,children:[(0,i.jsx)(Z.Z,{children:t+1}),(0,i.jsx)(Z.Z,{children:e.tenKe}),(0,i.jsx)(Z.Z,{children:e.vitriKm}),(0,i.jsx)(Z.Z,{children:e.chieuDai}),(0,i.jsx)(Z.Z,{children:e.vatLieu}),(0,i.jsx)(Z.Z,{children:(null===(n=e.geometry)||void 0===n?void 0:n.type)||"N/A"})]},t)})})]})})]})]})]}),(0,i.jsxs)(L.Z,{children:[(0,i.jsx)(g.Z,{onClick:()=>{F(null),I([]),G({tenKe:"",vitriKm:"",chieuDai:"",vatLieu:"",geometry:""}),z(null),X(null),U(null),ei(0)},disabled:R||0===P.length&&!E,children:"X\xf3a"}),(0,i.jsx)(g.Z,{onClick:t,disabled:R,children:"Đ\xf3ng"}),(0,i.jsx)(g.Z,{onClick:()=>{A&&0===P.length?eo():el()},variant:"contained",color:"primary",disabled:R||(A?!J.tenKe:0===P.length),startIcon:R?(0,i.jsx)(u.Z,{size:20}):(0,i.jsx)(D.Z,{}),children:R?"Đang lưu...":"Lưu"})]})]})}},42638:function(e,t,n){var i=n(67294),r=n(39153),o=n(45243),l=n.n(o),a=n(29291),c=n(92893),s=n(36637);t.Z=e=>{let t=(0,r.Sx)(),n=i.useRef(null),o=i.useRef({}),d=i.useRef(null),u=(0,a.Y)(),h=u.layerLabelState,g=u.focusedId,p=e.data||u.filteredKeList,m=e.onKeClick||u.handleKeClick;return i.useEffect(()=>{if(!t.getPane("kePane")){let e=t.createPane("kePane");e.style.zIndex="649",e.style.pointerEvents="auto"}},[t]),i.useEffect(()=>{if(n.current&&t.removeLayer(n.current),o.current={},!p||0===p.length)return;let e=l().featureGroup();return n.current=e,p.forEach((t,n)=>{try{var i,r,a,d;let g;let p=t.toaDo;if(!p){console.error("K\xe8 item ".concat(n," (").concat(t.tenKe,") has no toaDo property"));return}if("string"==typeof p)try{p=JSON.parse(p)}catch(e){console.error("Failed to parse toaDo string for k\xe8 ".concat(t.tenKe,":"),e),console.error("Invalid JSON string: ".concat(p.substring(0,100),"..."));return}if(!p){console.error("K\xe8 item ".concat(n," (").concat(t.tenKe,") has invalid toaDo after parsing"));return}if("object"!=typeof p){console.error("K\xe8 item ".concat(n," (").concat(t.tenKe,") has non-object toaDo after parsing:"),p);return}if(!p.geometry){if(console.error("K\xe8 item ".concat(n," (").concat(t.tenKe,") has invalid GeoJSON: missing geometry property"),p),!Array.isArray(p))return;p={type:"Feature",geometry:{type:"LineString",coordinates:p}}}if(!p.geometry.coordinates){console.error("K\xe8 item ".concat(n," (").concat(t.tenKe,") has invalid GeoJSON: missing coordinates property"),p.geometry);return}if(Array.isArray(p.geometry.coordinates)&&0===p.geometry.coordinates.length){console.error("K\xe8 item ".concat(n," (").concat(t.tenKe,") has empty coordinates array"),p.geometry);return}let y=t.color||"#3f51b5";try{if(p.type)g=p;else if(p.geometry)g={type:"Feature",geometry:p.geometry,properties:{name:t.tenKe}};else if(Array.isArray(p))g={type:"Feature",geometry:{type:"LineString",coordinates:p},properties:{name:t.tenKe}};else{console.error("Unrecognized GeoJSON format for k\xe8 ".concat(t.tenKe,":"),p);return}if(!g.type){console.error("Missing 'type' in GeoJSON for k\xe8 ".concat(t.tenKe));return}if("Feature"===g.type&&(!g.geometry||!g.geometry.type)){console.error("Invalid Feature geometry in GeoJSON for k\xe8 ".concat(t.tenKe));return}}catch(e){console.error("Error preparing GeoJSON for k\xe8 ".concat(t.tenKe,":"),e);return}if((null===(i=g.geometry)||void 0===i?void 0:i.type)==="Point"||"Feature"===g.type&&(null===(r=g.geometry)||void 0===r?void 0:r.type)==="Point"){let n=null===(d=g.geometry)||void 0===d?void 0:d.coordinates;if(!n||n.length<2){console.error("Invalid point coordinates for k\xe8 ".concat(t.tenKe,":"),n);return}let i=n[1],r=n[0],a=t.color||"#000",p=(0,c.oN)(u.legendData,t),y=(0,s.L)(i,r,p,a,{pane:"kePane"});e.addLayer(y),t.id&&(o.current[t.id]=y);let f=e=>null==e?"Chưa x\xe1c định":String(e).replace(/"/g,"&quot;").replace(/'/g,"&#39;"),v=f(t.tenKe||"Chưa c\xf3 t\xean"),x=f(t.loaiCongTrinh);t.maLoaiCongTrinh&&h[t.maLoaiCongTrinh]&&y.bindTooltip(t.tenKe,{permanent:!0,className:"map-label ke-label",opacity:1});let b='<div class="custom-popup"><h3>'.concat(v,"</h3>");x&&(b+="<p><strong>Loại c\xf4ng tr\xecnh:</strong> ".concat(x,"</p>")),t.diaDiem&&(b+="<p><strong>Địa điểm:</strong> ".concat(f(t.diaDiem),"</p>")),t.chieuDai&&(b+="<p><strong>Chiều d\xe0i:</strong> ".concat(f(t.chieuDai)," m</p>")),t.vatLieu&&(b+="<p><strong>Vật liệu:</strong> ".concat(f(t.vatLieu),"</p>")),b+='<div class="popup-footer"><em>Click để xem chi tiết</em></div></div>',y.bindPopup(b,{maxWidth:300,closeButton:!0}),y.on("click",e=>{let n=[e.latlng.lat,e.latlng.lng];m(t,n),l().DomEvent.stopPropagation(e)});return}let f=l().geoJSON(g,{style:{color:y,weight:2,opacity:.8,dashArray:(null===(a=g.geometry)||void 0===a?void 0:a.type)!=="Point"?"5, 10":void 0},pane:"kePane",interactive:!0,onEachFeature:(e,n)=>{var i;n instanceof l().Path&&(n.options.interactive=!0,n.on("mouseover",function(){n.setStyle({weight:5,opacity:1,color:"#ffffff"}),l().Browser.ie||l().Browser.opera||l().Browser.edge||n.bringToFront()}),n.on("mouseout",function(){var e;n.setStyle({weight:3,opacity:.8,color:y,dashArray:"10, 5"});let t=n.getTooltip();null==t||null===(e=t.getElement())||void 0===e||e.classList.remove("highlight-tooltip")})),n.on("click",e=>{let n=[e.latlng.lat,e.latlng.lng];m(t,n),l().DomEvent.stopPropagation(e)});let r=null==(i=t.tenKe||"Chưa c\xf3 t\xean")?"Chưa x\xe1c định":String(i).replace(/"/g,"&quot;").replace(/'/g,"&#39;");r&&h[t.maLoaiCongTrinh]&&n.bindTooltip(r,{permanent:!0,className:"map-label ke-label",opacity:1})}});e.addLayer(f),t.id&&(o.current[t.id]=f)}catch(e){console.error("Error creating layer for k\xe8 ".concat(t.tenKe,":"),e)}}),e.addTo(t),e.bringToFront(),()=>{n.current&&t.removeLayer(n.current)}},[p,t,m,u.legendData,h]),i.useEffect(()=>{if(d.current){try{t.removeLayer(d.current)}catch(e){}d.current=null}if(!g)return;let e=o.current[g];if(e)try{if(e.getLatLng){let n=e.getLatLng();t.flyTo(n,Math.max(t.getZoom(),15),{duration:.75});let i=l().circleMarker(n,{radius:10,color:"#ff9800",weight:3,opacity:.9,fillColor:"#ff9800",fillOpacity:.15,pane:"kePane"});i.addTo(t),i.bringToFront(),d.current=i;return}if(e.getBounds){let n=e.getBounds();if(n&&n.isValid&&n.isValid()){if(t.fitBounds(n,{padding:[40,40]}),e.toGeoJSON){let n=e.toGeoJSON(),i=l().geoJSON(n,{style:{color:"#ff9800",weight:6,opacity:.95},pane:"kePane"});i.addTo(t),i.bringToFront&&i.bringToFront(),d.current=i}return}}}catch(e){console.error("Kh\xf4ng thể zoom tới k\xe8 đ\xe3 chọn:",e)}},[g,t]),i.useEffect(()=>()=>{if(d.current){try{t.removeLayer(d.current)}catch(e){}d.current=null}},[t]),i.useEffect(()=>{if(!t)return;let e=()=>{let e=t.getZoom();setTimeout(()=>{document.querySelectorAll(".ke-label").forEach(t=>{e<12?(t.style.display="none",t.style.opacity="0",t.style.visibility="hidden",t.classList.add("ke-hidden-tooltip")):(t.style.display="block",t.style.opacity="1",t.style.visibility="visible",t.classList.remove("ke-hidden-tooltip"))})},100)};return t.on("zoomend",e),e(),()=>{t.off("zoomend",e)}},[t]),null}}}]);